<!DOCTYPE html>
<html lang="en">


<!-- Draggable DIV -->
<div id="mydiv">
  <!-- Include a header DIV with the same name as the draggable DIV, followed by "header" -->
  <button id="mydivheader" class="btn btn-xs">#</button>
  <details open class="dropdown">
    
    <summary class="btn-outline" >Expand</summary>
  <div id='cssmenu'>
    <ul class="menu lg:menu-horizontal bg-base-200 rounded-box lg:mb-64">
      <li>
        <details>
          <summary>File</summary>
          <ul>
            <li><a class="btn btn-ghost" id="save-btn" href="#">Save</a></li>
            <li><a class="btn btn-ghost" id="destroy-btn" href="#">Destroy</a></li>
            <li><a class="btn btn-ghost" id="create-btn" href="#">Create</a></li>
          </ul>
        </details>
      </li>
      <li>
        <details>
          <summary>Insert</summary>
          <ul>
            <li><div class="btn">
              <!-- manually force a drop size of 2x2 for nested size -->
              <div class="grid-stack-item" gs-w="2" gs-h="1" id="nestedpress">
                <div class="grid-stack-item-content" id="nesteddrag">Nest</div>
              </div>


              
            </div></li>

            <li><div class="">
              <!-- manually force a drop size of 2x2 for nested size -->
              <div class="grid-stack-item" gs-w="2" gs-h="1" id="widgetpress" contentEditable="true">
                <div class="grid-stack-item-content" id="widgetdrag">Widget</div>
              </div>
              
            </div></li>


            <li><div class="sidebar">
              <!-- manually force a drop size of 2x2 for nested size -->
              <div class="grid-stack-item" gs-w="2" gs-h="1" id="">
                <div class="grid-stack-item-content" id=""> 
                  <button class="chuncky-btn" onClick="grid.removeWidget(this.parentNode.parentNode)">X</button>
                  <!-- Open the modal using ID.showModal() method -->
                  <button class="grid-stack-item-id chuncky-btn" onClick="console.log('self id is:')">id:</button>
                  <button class="chuncky-btn" onclick="my_modal_2.showModal()">Configurator</button>
                  <br>
                  
                </div>
              </div>
            </div></li>



           
            <dialog id="my_modal_2" class="modal">
              <div class="modal-box">
                <h3 class="text-lg font-bold">Configurator</h3>
                <p class="py-4">Add/select stream for grid-id</p>
                {<input id="App-Configurator-select-grid-select"></input>}
                <details>
                  <summary id="App-Configurator-active-grids-dropdown">Grids</summary>
                  
                    <ul class="menu menu-xs bg-base-200 rounded-lg " id="App-Configurator-active-grids-dropdown-content">
                    </ul>
                
                  </details>
                  
                  <p class="py-4">Select Widget Type</p>
                  {<input id="App-Configurator-select-WidgetType-input"></input>}
                  <details>
                    <summary id="App-Configurator-active-WidgetType-dropdown">Type</summary>
                    
                      <ul class="menu menu-xs bg-base-200 rounded-lg " id="App-Configurator-active-WidgetType-dropdown-content">
                      </ul>
                  
                  </details>
              
                <p class="py-4">Current Stream {}</p>
                
                <input id="App-Configurator-select-stream-input" class="width-inherit">
                <details>
                  <summary id="App-Configurator-active-streams-dropdown">Streams</summary>
                  
                    <ul class="menu menu-xs bg-base-200 rounded-lg " id="App-Configurator-active-streams-dropdown-content">
                    </ul>
                
                  </details>
                  <button class="btn" id="App-Configurator-save-btn">Save</button>
                </div>
                <form method="dialog" class="modal-backdrop">
                  <button type="submit">close</button>
                </form>
              </dialog>


              <li><div class="trash" id="trash">Drop to remove</div></li>
            </ul>
          </details>
        </li>
        <li>
          <details>
            <summary>Load</summary>
            <ul>
              <li><a class="btn btn-ghost" id="save-list-btn" href="#">Save list</a></li>
              <li><a class="btn btn-ghost" id="save-no-content-btn" href="#">Save no content</a></li>
              <li><a class="btn btn-ghost" id="clear-btn" href="#">Clear</a></li>
              <li><a class="btn btn-ghost" id="load-btn" href="#">Load</a></li>
            </ul>
          </details>
        </li>
        <li>
          <details>
            <summary>AriesMods</summary>
            <div id="ariesModsDropZone" class="aries-mods-drop-zone">
              <div class="drop-zone-inner">
                <div class="drop-zone-content">
                  <i class="text-2xl">ðŸ“¦</i>
                  <p>Drag and drop AriesMod (.js) files here</p>
                  <p class="text-sm">or</p>
                  <button class="btn btn-sm" onclick="document.getElementById('ariesModFileInput').click()">
                    Browse Files
                  </button>
                  <input type="file" id="ariesModFileInput" accept=".js" style="display: none;" />
                </div>
              </div>
              <div id="installedMods" class="installed-mods">
                <h4 class="text-sm font-bold mt-2">Installed Mods</h4>
                <ul id="ariesModsList" class="text-sm"></ul>
              </div>
            </div>
          </details>
        </li>
      </ul>
      </div>
      </details>
</div>


<head>
  <script src="./assets/js/core/jquery.min.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'blob:' 'unsafe-eval'">
  <title>dash</title>
  <link rel="stylesheet" href="./assets/css/gridstackdemo.css"/>
  <link href="./assets/node_modules/gridstack/dist/gridstack-extra.min.css" rel="stylesheet"/>
  <script src="./assets/node_modules/gridstack/dist/gridstack-all.js"></script>
<!--<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" /> -->
  <link href="../node_modules/daisyui/dist/full.css" rel="stylesheet" type="text/css" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="./assets/css/toolbar.css" rel="stylesheet" type="text/css" />
  <script src="./assets/js/custom/toolbar.js"></script>

  <script src="./assets/js/custom/gridstackevents.js"></script>

  <link href="./assets/css/aresv2.css" rel="stylesheet" type="text/css" />

  <link href="./assets/css/electron.css" rel="stylesheet" type="text/css" />

  <link rel="stylesheet" href="assets/css/sidebar.css">
  <link rel="stylesheet" href="assets/css/animate.min.css">
  <script src="./assets/js/custom/sidebar.js" defer></script>

  <!-- Web fonts -->
  <link rel="stylesheet" href="./assets/fonts/Railway-OpenSans.css">

  <!-- Add these new stylesheets -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css" /> -->
</head>
<body>
  <div id="app"></div> <!-- React will render here -->
  <div id="page-container" class="modern-sf">

<marquee direction="left" speed="normal" behavior="loop" class="marquee top-bar h-5 cursor-grab" id="AriesUI-app-scroll-status">
  Status {}
</marquee>
<header id="header-main">`

  <div class="navbar">
    <div class="flex-1">
      <div class="flex-1 on-top text-3xl main-title"><span>// </span><a class="link-sf" id="title-main" onclick="openNav()">comms</a></div>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal px-1">
        <li class="on-top">
          <details>
            <summary id="SH-active-streams-dropdown">Streams</summary>
            
              <ul class="menu menu-xs bg-base-200 rounded-lg " id="SH-active-streams-dropdown-content">
                </ul>
            
            </details>
          </li>
          <li class="on-top">
            <details>
              <summary class="text animated infinite pulse pull-right" id="App-live-status-dropdown"><a>[Link]</a></summary>
              <ul>
                <li>
                  <details>
                    <summary id="SH-live-status" class="text animated infinite pulse pull-right">StreamHandler</summary>
                    <ul>
                      <li><a id="Itf-connect-btn">Connect</a></li>
                      <li><a id="Itf-close-btn">Disconnect</a></li>
                      <li><label class="label-text">Reconnect</label><input type="checkbox" class="toggle" checked="checked" id="Itf-reconnect-btn"/></li>
                      
                    </ul>
                  </details>
                  <details>
                    <summary class="disabled">ariesUI</summary>
                    <ul>
                      <li class="disabled"><a>Connect</a></li>
                      <li class="disabled"><a>Disconnect</a></li>
                    </ul>
                  </details>
                  <details>
                    <summary class="disabled">Engine</summary>
                    <ul>
                      <li class="disabled"><a>Connect</a></li>
                      <li class="disabled"><a>Disconnect</a></li>
                    </ul>
                  </details>
                </li>
              </ul>
            </details>
          </li>
          
         <!-- device menu <li class="on-top">
            <details>
              <summary>Device</summary>
              <ul>
                <li><button id="clickButton" class="button btn-primary">Click Me</button></li>
                <li><button id="successButton" class="button btn-success">Success</button></li>
                <li><a>Submenu 1</a></li>
                <li><a>Submenu 2</a></li>
                <li>
                  <details open>
                    <summary>Parent</summary>
                    <ul>
                      <li><a>item 1</a></li>
                      <li><a>item 2</a></li>
                    </ul>
                  </details>
                </li>
              </ul>
            </details>
          </li> -->

        </ul>
      </div>
    </div>
   </header>
   

  <div id="mySidenav" class="sidenav" onmouseleave="closeNav()" style="left: 0%; width: 0px;">
    <a href="#" class="nav-link">Dashboard</a>
    <a href="#" class="nav-link" onclick="document.getElementById('config-modal').showModal()">Config</a>
    <a href="#" class="nav-link" onclick="document.getElementById('logs-modal').showModal()">Logs</a>
    <a href="#" class="nav-link" onclick="document.getElementById('terminal-modal').showModal()">Terminal</a>

  <!-- <a href="#" class="nav-link">Comms</a> -->
   <!-- <a href="DAQ.html" class="nav-link">DAQ</a> -->
    <a href="#" class="nav-link" onclick="document.getElementById('marketplace-modal').showModal()">AriesMods</a>
    <a href="#" class="nav-link" onclick="document.getElementById('performance-modal').showModal()">Performance</a>
  </div>

  <!-- Add this terminal dialog -->
<dialog id="terminal-modal" class="modal">
  <div class="modal-box w-11/12 max-w-5xl h-[80vh]">
    <h3 class="font-bold text-lg">Terminal</h3>
    <div id="terminal-container" class="bg-black text-green-500 p-4 h-[90%] overflow-y-auto font-mono">
      <div id="terminal-output"></div>
      <div class="terminal-input-line">
        <span class="terminal-prompt">></span>
        <input type="text" id="terminal-input" class="bg-transparent border-none outline-none text-green-500 w-[90%]">
      </div>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

  <div id="myDevicenav" class="sidenav" onmouseleave="closeDeviceNav()" style="left: 82%; width: 0px; visibility: hidden;">
      <a href="#" class="nav-link">WiFi</a>
      <a href="#" class="nav-link">Mavlink</a>
      <a href="#" class="nav-link">Bluetooth</a>
      <a href="#" class="nav-link">LabJack</a>
      <a href="#" class="nav-link">RS</a>
      <a href="#" class="nav-link">SSH</a>
      <a href="#" class="nav-link">LoRa</a>
    </div>
  
  </div>
  <div class="container-fluid">

<!-- Config Modal -->
<dialog id="config-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Configuration Settings</h3>
    <div class="py-4">
      <label class="label">
        <span class="label-text">Theme</span>
      </label>
      <label class="swap swap-rotate">
        <input type="checkbox" id="theme-toggle" />
        <div class="swap-on">DARKMODE</div>
        <div class="swap-off">LIGHTMODE</div>
      </label>
      <button class="btn btn-primary mt-4" onclick="saveConfig()">Save Config</button>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>Close</button>
    </form>
  </div>
</dialog>




<!-- Logs Modal -->
<dialog id="logs-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Application Logs</h3>
    <div class="py-4">
      <div id="logs-container" class="bg-black text-green-500 p-4 h-64 overflow-y-auto font-mono"></div>
      <button class="btn btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
      <div class="mt-4 text-gray-500">
        <p>Engine Logs (Coming Soon)</p>
        <p>StreamHandler Logs (Coming Soon)</p>
      </div>
    </div>
    <form method="dialog">
      <button>Close</button>
    </form>
  </div>
</dialog>

<!-- Performance Modal -->
<dialog id="performance-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Performance Metrics</h3>
    <div class="py-4">
      <canvas id="performance-chart" width="400" height="200"></canvas>
      <div id="performance-text" class="mt-4"></div>
    </div>
    <form method="dialog">
      <button>Close</button>
    </form>
  </div>
</dialog>




  <!-- Marketplace Modal -->
  <dialog id="marketplace-modal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
      <h3 class="font-bold text-lg">AriesMods Marketplace</h3>
      <div class="py-4">
        <!-- Git URL Config -->
        <div class="mb-4">
          <label class="label">
            <span class="label-text">Mods JSON Git URL</span>
          </label>
          <input type="text" id="git-url-input" class="input input-bordered w-full" value="https://raw.githubusercontent.com/yourusername/aries-mods/main/mods.json" />
          <button class="btn btn-sm btn-primary mt-2" onclick="saveGitUrl()">Save Git URL</button>
        </div>

        <!-- Installed Mods -->
        <section class="mb-6">
          <h4 class="text-xl font-bold mb-4">Installed Mods</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="installed-mods"></div>
          <button class="btn btn-error btn-sm mt-4" onclick="clearAllMods()">Clear All Mods</button>
        </section>

        <!-- All Mods -->
        <section>
          <h4 class="text-xl font-bold mb-4">Available Mods</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="all-mods"></div>
        </section>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>Close</button>
      </form>
    </div>
  </dialog>
</div>

<div id="toast" class="fixed bottom-4 right-4 p-4 bg-gray-800 text-white rounded shadow-lg hidden"></div>


    <!-- Main map/terrain overview

     -->
    <!-- Sensor values -->

    
    <!-- Graphs -->

    
    <!-- Add more grid items as needed -->
  </div>
  
  <!-- Status bar -->
  <div class="status-bar">
    <span id="status-message">System Status: Operational</span>
    <span id="current-time"></span>
  </div>
  <script>
  

  // Function to apply the theme to the HTML tag
function applyTheme(theme) {
  document.querySelector('html').setAttribute('data-theme', theme);
  document.body.className = theme;
  document.getElementById('theme-select').value = theme;
}

// Load the saved theme when the page loads
document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to 'light' if no saved theme
  applyTheme(savedTheme);
  // Set the checkbox state based on the saved theme
  document.getElementById('theme-toggle').checked = savedTheme === 'dark';
  
});

// Toggle theme when the checkbox is clicked
document.getElementById('theme-toggle').addEventListener('change', (e) => {
  const newTheme = e.target.checked ? 'dark' : 'light';
  applyTheme(newTheme);
  localStorage.setItem('theme', newTheme); // Save the theme to localStorage
});

// Optional: Save config function (if you have additional settings)
function saveConfig() {
  const theme = document.getElementById('theme-toggle').checked ? 'dark' : 'light';
  localStorage.setItem('theme', theme);
  showToast(`Theme set to ${theme}`); // Optional feedback
}

// Optional: Toast notification function for user feedback
function showToast(message) {
  const toast = document.getElementById('toast');
  if (toast) {
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }
}


  </script>
  <script>
   
    const { ipcRenderer } = require('electron');

    let performanceChart;
  
  function loadLogs() {
    ipcRenderer.send('get-logs');
  }

  ipcRenderer.on('logs', (event, logs) => {
    document.getElementById('logs-container').textContent = logs;
  });

  function clearLogs() {
    document.getElementById('logs-container').textContent = '';
    // Optionally, you could add IPC to clear the log file on disk
  }

  // Load logs when modal opens
  document.getElementById('logs-modal').addEventListener('show', loadLogs);

  
    // Request performance data
    function updatePerformanceMetrics() {
      ipcRenderer.send('get-performance-metrics');
    }
  
    // Receive and display performance data
    ipcRenderer.on('performance-metrics', (event, { cpuUsage, memoryUsage }) => {
      document.getElementById('performance-text').innerHTML = `
        <p>CPU Usage: ${cpuUsage.toFixed(2)}%</p>
        <p>Memory Usage: ${memoryUsage} MB</p>
      `;
  
      // Initialize chart if not already done
      if (!performanceChart) {
        const ctx = document.getElementById('performance-chart').getContext('2d');
        performanceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'CPU Usage (%)', data: [], borderColor: 'red', fill: false },
              { label: 'Memory Usage (MB)', data: [], borderColor: 'blue', fill: false }
            ]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }
  
      // Update chart
      const now = new Date().toLocaleTimeString();
      performanceChart.data.labels.push(now);
      performanceChart.data.datasets[0].data.push(cpuUsage);
      performanceChart.data.datasets[1].data.push(memoryUsage);
      if (performanceChart.data.labels.length > 20) {
        performanceChart.data.labels.shift();
        performanceChart.data.datasets[0].data.shift();
        performanceChart.data.datasets[1].data.shift();
      }
      performanceChart.update();
    });
  
    // Update every 2 seconds
    setInterval(updatePerformanceMetrics, 2000);
  </script>
  <script type="module">
    import { initializeGrid, addWidget, addNested, setupDragIn } from './assets/js/custom/gridManager.js';
  
    const grid = initializeGrid('.container-fluid');
  
    document.getElementById('nestedpress').addEventListener('click', () => addNested(grid));
    document.getElementById('widgetpress').addEventListener('click', () => addWidget(grid));

    
  
    setupDragIn('.sidebar .grid-stack-item');
  </script>
  

  <!-- logic -->
  <script src="./assets/js/logic/stream_interface.js" defer></script>

  <!-- vanilla reacivity -->
  <script src="./assets/js/custom/ariesUI.js" type="module"></script>
      
  <!-- Load React Bundle -->
  <script src="./assets/js/core/bundle.js"></script>


  <!-- Add these new scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- // You'd need to include Rollup and/or babel in your HTML -->
  <script src="https://unpkg.com/rollup@3.0.0-2/dist/rollup.browser.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="../node_modules/react/umd/react.development.js"></script>
  <script src="../node_modules/react-dom/umd/react-dom.development.js"></script>

  <!-- Audio elements (can be hidden) -->


  <audio id="startupSound" preload="auto"></audio>
  <audio id="clickSound" preload="auto"></audio>
  <audio id="successSound" preload="auto"></audio>

  <script type="module">
    const { ipcRenderer } = require('electron');
    const { playSound } = require('../renderer.cjs');
    
    let audioFiles = {};
    
    // Configure audio sources
    ipcRenderer.on('audio-config', (event, files) => {
      audioFiles = files;
      document.getElementById('startupSound').src = files.startup;
      document.getElementById('clickSound').src = files.click;
      document.getElementById('successSound').src = files.success;
      document.getElementById('negativeSound').src = files.negative;
    });

    // Handle main process audio triggers
    ipcRenderer.on('play-audio', (event, soundKey) => {
      playSound(soundKey);
    });

    document.addEventListener('click', () => {
      playSound('click');
    });
    // Add button event listeners
    document.getElementById('clickButton').addEventListener('click', () => {
      playSound('click');
    });

    document.getElementById('successButton').addEventListener('click', () => {
      playSound('success');
    });

    window.playsound = function playsound(name){
      playSound(name);
    }

    // Optional: Add hover effects
    const buttons = document.querySelectorAll('.button');
    buttons.forEach(button => {
      button.addEventListener('mouseenter', () => {
        playSound('hover'); // Assumes you add a hover.mp3
      });
    });
  </script>

  

  <div id="root"></div>
  <script>
    // Override console.log
    const originalConsoleLog = console.log;
    console.log = function() {
      // Call original console.log
      originalConsoleLog.apply(console, arguments);
      
      // Add to terminal
      const timestamp = new Date().toISOString();
      const message = Array.from(arguments).join(' ');
      addTerminalMessage(timestamp, message);
    };

    function addTerminalMessage(timestamp, message) {
      const terminal = document.getElementById('terminal-output');
      const messageElement = document.createElement('div');
      messageElement.className = 'terminal-message';
      messageElement.innerHTML = `<span class="terminal-timestamp">[${timestamp}]</span> ${message}`;
      terminal.appendChild(messageElement);
      
      // Auto scroll to bottom
      terminal.scrollTop = terminal.scrollHeight;
    }

    function openTerminal() {
      document.getElementById('terminal-modal').showModal();
      document.getElementById('terminal-input').focus();
    }

    // Handle terminal input
    document.getElementById('terminal-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const command = this.value;
        
        // Add command to output
        addTerminalMessage(new Date().toISOString(), `$ ${command}`);
        
        try {
          // Evaluate command and log result
          const result = eval(command);
          if (result !== undefined) {
            console.log(result);
          }
        } catch (error) {
          console.log('Error:', error.message);
        }
        
        // Clear input
        this.value = '';
      }
    });

    // Keep terminal scrolled to bottom when new content is added
    const terminalOutput = document.getElementById('terminal-output');
    const observer = new MutationObserver(() => {
      terminalOutput.scrollTop = terminalOutput.scrollHeight;
    });
    
    observer.observe(terminalOutput, {
      childList: true,
      subtree: true
    });
  </script>

<script>
  // Global Git URL (default, modifiable)
  window.gitUrl = localStorage.getItem('gitUrl') || 'https://raw.githubusercontent.com/yourusername/aries-mods/main/mods.json';

  // Local storage helpers
  function saveInstalledMod(widgetName, gitUrl) {
    let installedMods = JSON.parse(localStorage.getItem('installedMods')) || [];
    if (!installedMods.some(mod => mod.gitUrl === gitUrl)) {
      installedMods.push({ name: widgetName, gitUrl });
      localStorage.setItem('installedMods', JSON.stringify(installedMods));
      update_app_widget_type_list(installedMods); // Pass full list
      updateInstalledMods(); // Ensure UI updates
    }
  }

  function getInstalledMods() {
    return JSON.parse(localStorage.getItem('installedMods')) || [];
  }

  function uninstallMod(gitUrl) {
    let installedMods = getInstalledMods();
    const mod = installedMods.find(m => m.gitUrl === gitUrl);
    if (mod) {
      installedMods = installedMods.filter(m => m.gitUrl !== gitUrl);
      localStorage.setItem('installedMods', JSON.stringify(installedMods));
      delete window[mod.name];
      update_app_widget_type_list(installedMods);
      updateInstalledMods();
    }
  }

  function clearAllMods() {
    const installedMods = getInstalledMods();
    installedMods.forEach(mod => delete window[mod.name]);
    localStorage.setItem('installedMods', JSON.stringify([]));
    update_app_widget_type_list([]);
    updateInstalledMods();
  }

  // Fetch mods from Git
  async function fetchMods() {
    try {
      const response = await fetch(window.gitUrl);
      return await response.json();
    } catch (error) {
      console.error('Failed to fetch mods:', error);
      return [];
    }
  }

  // Reload a mod from its Git URL
  async function reloadMod(mod) {
    if (!window[mod.name]) {
      try {
        const code = await (await fetch(mod.gitUrl)).text();
        const blob = new Blob([code], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const module = await import(url);
        window[mod.name] = module.default;
        console.log(`Reloaded ${mod.name} from ${mod.gitUrl}`);
        URL.revokeObjectURL(url);
        update_app_widget_type_list(getInstalledMods());
      } catch (error) {
        console.error(`Failed to reload ${mod.name}:`, error);
      }
    }
  }

  // Mod handling
  function handleFiles(files) {
    [...files].forEach(file => {
      if (file.name.endsWith('.js')) {
        const reader = new FileReader();
        reader.onload = async function(event) {
          const code = event.target.result;
          try {
            const blob = new Blob([code], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const module = await import(url);
            const widgetName = file.name.replace('.js', '');
            window[widgetName] = module.default;
            console.log(`AriesMod: Loaded ${widgetName}`);
            saveInstalledMod(widgetName, 'manual-upload://' + widgetName);
            AddModToList(file.name);
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Error importing the widget code:', error);
          }
        };
        reader.readAsText(file);
      } else {
        console.warn('Only .js files are supported for AriesMods');
      }
    });
  }

  // Create mod card for marketplace
  function createModCard(mod) {
    const isInstalled = getInstalledMods().some(m => m.gitUrl === mod.gitUrl);
    return `
      <div class="card bg-base-100 shadow-xl" data-mod-name="${mod.name}">
        <div class="card-body">
          <h2 class="card-title">${mod.title || mod.name}</h2>
          <p>${mod.description}</p>
          <div class="flex gap-2 mt-2">
            <span class="badge badge-outline">v${mod.version}</span>
          </div>
          <div class="card-actions justify-end mt-4">
            <button class="btn btn-primary btn-sm" onclick="installMod('${mod.name}', '${mod.gitUrl}')" ${isInstalled ? 'disabled' : ''}>
              ${isInstalled ? 'Installed' : 'Install'}
            </button>
          </div>
        </div>
      </div>
    `;
  }

  // Create installed mod card for marketplace and toolbar
  function createInstalledModCard(mod) {
    const modInfo = window.availableMods?.find(m => m.gitUrl === mod.gitUrl) || { title: mod.name, description: 'Custom widget' };
    return `
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">${modInfo.title || mod.name} {GIT - ${mod.name}}</h2>
          <p>${modInfo.description}</p>
          <div class="card-actions justify-end mt-4">
            <button class="btn btn-error btn-sm" onclick="uninstallMod('${mod.gitUrl}')">Uninstall</button>
          </div>
        </div>
      </div>
    `;
  }

  // Create toolbar mod list item
  function createToolbarModItem(mod) {
    return `
      <li><span>${mod.name} {GIT - ${mod.name}}</span><button class="btn btn-xs btn-ghost" onclick="uninstallMod('${mod.gitUrl}')">Ã—</button></li>
    `;
  }

  // Update installed mods (both marketplace and toolbar)
  function updateInstalledMods() {
    const installedMods = getInstalledMods();
    const marketplaceContainer = document.getElementById('installed-mods');
    const toolbarContainer = document.getElementById('ariesModsList');

    // Update marketplace modal
    marketplaceContainer.innerHTML = installedMods.length > 0
      ? installedMods.map(createInstalledModCard).join('')
      : '<p>No mods installed yet.</p>';

    // Update toolbar
    toolbarContainer.innerHTML = installedMods.length > 0
      ? installedMods.map(createToolbarModItem).join('')
      : '<li><span>No mods installed</span></li>';
  }

  // Install mod
  async function installMod(widgetName, gitUrl) {
    await reloadMod({ name: widgetName, gitUrl });
    saveInstalledMod(widgetName, gitUrl);
    updateInstalledMods();
  }

  // Save Git URL globally and update UI
  function saveGitUrl() {
    const newGitUrl = document.getElementById('git-url-input').value;
    window.gitUrl = newGitUrl;
    localStorage.setItem('gitUrl', newGitUrl);
    console.log('Git URL updated to:', newGitUrl);
    document.getElementById('git-url-input').value = newGitUrl; // Reflect in UI immediately
    fetchAndDisplayMods();
  }

  // Fetch and display mods
  async function fetchAndDisplayMods() {
    window.availableMods = await fetchMods();
    updateInstalledMods();
    document.getElementById('all-mods').innerHTML = window.availableMods.map(createModCard).join('');
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async () => {
    const installedMods = getInstalledMods();
    for (const mod of installedMods) {
      await reloadMod(mod);
    }
    fetchAndDisplayMods();
    document.getElementById('git-url-input').value = window.gitUrl; // Set initial Git URL in UI
  });

  // Navigation
  function openNav() {
    document.getElementById("mySidenav").style.width = "250px";
  }

  function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
  }

  // Placeholder for update_app_widget_type_list if not defined elsewhere
  window.update_app_widget_type_list = window.update_app_widget_type_list || function(modsList) {
    console.log('Updated widget types:', modsList.map(m => `${m.name} {GIT - ${m.name}}`));
    const widgetTypeList = document.getElementById('App-Configurator-active-WidgetType-dropdown-content');
    widgetTypeList.innerHTML = modsList.length > 0
      ? modsList.map(mod => `<li><a>${mod.name} {GIT - ${mod.name}}</a></li>`).join('')
      : '<li><a class="text-danger">{0 Active}</a></li>';
  };

  function AddModToList(modName) {
    console.log('Added to mod list:', modName);
    updateInstalledMods(); // Ensure toolbar updates when adding via dropzone
  }
</script>

  <style>
    .aries-mods-drop-zone {
      width: 300px;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }

    .drop-zone-inner {
      border: 2px dashed #ccc;
      border-radius: 6px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .drop-zone-inner.drag-over {
      background: rgba(0, 0, 0, 0.1);
      border-color: #666;
    }

    .drop-zone-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .installed-mods {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }

    #ariesModsList {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0;
    }

    #ariesModsList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0;
    }
  </style>

  <!-- Add before the closing body tag -->
  <script>

    // Toast functionality
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // AriesMods Drop Zone functionality
    const dropZone = document.getElementById('ariesModsDropZone');
    const dropZoneInner = dropZone.querySelector('.drop-zone-inner');
    const fileInput = document.getElementById('ariesModFileInput');
    var modsList = [];

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone when dragging over it
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZoneInner.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZoneInner.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZoneInner.classList.add('drag-over');
    }

    function unhighlight(e) {
      dropZoneInner.classList.remove('drag-over');
    }

    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      handleFiles(files);
    }

    /*
    
  
    function handleFiles(files) {
  [...files].forEach(file => {
    if (file.name.endsWith('.js')) {
      const reader = new FileReader();
      reader.onload = async function(event) {
  const code = event.target.result;
  console.log('File content:', code); // Debug: See what's actually being read
  window.code = code;
  
  try {
    const blob = new Blob([code], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    const module = await import(url);
    window.GraphDisplay = module.default;
    console.log('AriesMod: Evaluated');
    AddModToList(file.name);
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Error importing the widget code:', error);
  }
};
  reader.readAsText(file);
    } else {
      console.warn('Only .js files are supported for AriesMods');
    }
  });
}

*/




function handleFiles(files) {
  [...files].forEach(file => {
    if (file.name.endsWith('.js')) {
      const reader = new FileReader();
      reader.onload = async function(event) {
        const code = event.target.result;
        try {
          const blob = new Blob([code], { type: 'application/javascript' });
          const url = URL.createObjectURL(blob);
          const module = await import(url);
          const widgetName = file.name.replace('.js', '');
          window[widgetName] = module.default;
          console.log(`AriesMod: Loaded ${widgetName}`);
          // For manual uploads, assume a placeholder Git URL or prompt user to add it
          saveInstalledMod(widgetName, 'manual-upload://' + widgetName);
          AddModToList(file.name);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Error importing the widget code:', error);
        }
      };
      reader.readAsText(file);
    } else {
      console.warn('Only .js files are supported for AriesMods');
    }
  });
}

function saveInstalledMod(widgetName, gitUrl) {
  let installedMods = JSON.parse(localStorage.getItem('installedMods')) || [];
  if (!installedMods.some(mod => mod.gitUrl === gitUrl)) {
    installedMods.push({ name: widgetName, gitUrl });
    localStorage.setItem('installedMods', JSON.stringify(installedMods));
  }
}

// Reload a mod from its Git URL
async function reloadMod(mod) {
  if (!window[mod.name]) {
    try {
      const code = await (await fetch(mod.gitUrl)).text();
      const blob = new Blob([code], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      const module = await import(url);
      window[mod.name] = module.default;
      console.log(`Reloaded ${mod.name} from ${mod.gitUrl}`);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error(`Failed to reload ${mod.name}:`, error);
    }
  }
}

// Restore installed mods on page load
document.addEventListener('DOMContentLoaded', async () => {
  const installedMods = JSON.parse(localStorage.getItem('installedMods')) || [];
  for (const mod of installedMods) {
    await reloadMod(mod);
  }
});



    function AddModToList(modName) {
      modsList.push(modName);
      update_app_widget_type_list(modsList, name);
      console.log('Added to mod list:', name);
    }

    window.RemoveModToList = function RemoveModToList(modName) {
      modsList.pop(modName);
      update_app_widget_type_list(modsList);
    }

 
  </script>

  <!-- Add event listener for any click to play a sound effect -->


</body>
</html>
